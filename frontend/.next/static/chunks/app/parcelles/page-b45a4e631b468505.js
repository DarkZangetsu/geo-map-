(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[606],{3225:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});var s=r(5155);function l(e){let{isOpen:t,onClose:r,onConfirm:l,title:i,message:a,confirmText:n="Confirmer",cancelText:o="Annuler",confirmButtonClass:c="bg-green-600 hover:bg-green-700",cancelButtonClass:d="bg-gray-300 hover:bg-gray-400",confirmLoading:u=!1,confirmDisabled:m=!1}=e;return t?(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:i}),(0,s.jsx)("p",{className:"text-gray-600 mb-6",children:a}),(0,s.jsxs)("div",{className:"flex justify-end gap-3",children:[(0,s.jsx)("button",{onClick:r,className:"px-4 py-2 rounded font-semibold text-gray-700 ".concat(d),disabled:u,children:o}),(0,s.jsxs)("button",{onClick:l,className:"px-4 py-2 rounded font-semibold text-white flex items-center justify-center gap-2 ".concat(c),disabled:m,children:[u&&(0,s.jsx)("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2 inline-block"}),n]})]})]})}):null}r(2115)},6254:(e,t,r)=>{"use strict";r.d(t,{AuthProvider:()=>o,h:()=>c});var s=r(5155),l=r(2115);r(9624);var i=r(5695),a=r(5384);let n=(0,l.createContext)();function o(e){let{children:t}=e,[r,o]=(0,l.useState)(null),[c,d]=(0,l.useState)(!1),[u,m]=(0,l.useState)(!0),[x,h]=(0,l.useState)(!1),p=(0,i.useRouter)();(0,l.useEffect)(()=>{let e=a.Ep.getToken(),t=a.Ep.getUser(),r=window.location.pathname;e&&t&&!a.Ep.isTokenExpired(e)?(o(t),d(!0)):(o(null),d(!1),a.Ep.clearAuthData(),["/","/login","/register","/pepinieres-globales","/parcelles-globales","/sieges-globaux"].includes(r)||p.push("/login")),m(!1)},[p]);let g=async()=>{h(!0),await new Promise(e=>setTimeout(e,700)),a.Ep.clearAuthData(),o(null),d(!1),h(!1);let e=window.location.pathname;"/"!==e&&"/login"!==e&&"/register"!==e&&p.push("/")};return(0,s.jsx)(n.Provider,{value:{user:r,isAuthenticated:c,isLoading:u,isLoggingOut:x,login:(e,t)=>{if("string"!=typeof t||!t.trim())return void console.error("Tentative de login avec un token invalide:",t);a.Ep.setAuthData(t,e),o(e),d(!0)},logout:g},children:t})}function c(){return(0,l.useContext)(n)}},7075:(e,t,r)=>{"use strict";r.d(t,{bq:()=>u,eb:()=>x,gC:()=>m,l6:()=>c,yv:()=>d});var s=r(5155);r(2115);var l=r(8893),i=r(6474),a=r(5196),n=r(7863),o=r(5384);function c(e){let{...t}=e;return(0,s.jsx)(l.bL,{"data-slot":"select",...t})}function d(e){let{...t}=e;return(0,s.jsx)(l.WT,{"data-slot":"select-value",...t})}function u(e){let{className:t,size:r="default",children:a,...n}=e;return(0,s.jsxs)(l.l9,{"data-slot":"select-trigger","data-size":r,className:(0,o.cn)("border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",t),...n,children:[a,(0,s.jsx)(l.In,{asChild:!0,children:(0,s.jsx)(i.A,{className:"size-4 opacity-50"})})]})}function m(e){let{className:t,children:r,position:i="popper",...a}=e;return(0,s.jsx)(l.ZL,{children:(0,s.jsxs)(l.UC,{"data-slot":"select-content",className:(0,o.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md","popper"===i&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:i,...a,children:[(0,s.jsx)(h,{}),(0,s.jsx)(l.LM,{className:(0,o.cn)("p-1","popper"===i&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"),children:r}),(0,s.jsx)(p,{})]})})}function x(e){let{className:t,children:r,...i}=e;return(0,s.jsxs)(l.q7,{"data-slot":"select-item",className:(0,o.cn)("focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",t),...i,children:[(0,s.jsx)("span",{className:"absolute right-2 flex size-3.5 items-center justify-center",children:(0,s.jsx)(l.VF,{children:(0,s.jsx)(a.A,{className:"size-4"})})}),(0,s.jsx)(l.p4,{children:r})]})}function h(e){let{className:t,...r}=e;return(0,s.jsx)(l.PP,{"data-slot":"select-scroll-up-button",className:(0,o.cn)("flex cursor-default items-center justify-center py-1",t),...r,children:(0,s.jsx)(n.A,{className:"size-4"})})}function p(e){let{className:t,...r}=e;return(0,s.jsx)(l.wn,{"data-slot":"select-scroll-down-button",className:(0,o.cn)("flex cursor-default items-center justify-center py-1",t),...r,children:(0,s.jsx)(i.A,{className:"size-4"})})}},9624:(e,t,r)=>{"use strict";r.d(t,{A:()=>x});var s=r(8592),l=r(524),i=r(2641),a=r(4076),n=r(1957),o=r(883),c=r(9159);let d=(0,o.A)({uri:"".concat("http://91.204.209.201:8000","/graphql/")}),u=(0,a.o)((e,t)=>{let{headers:r}=t,s=localStorage.getItem("token");if(s)try{let e=(0,c.s)(s),t=Date.now()/1e3;if(e.exp<t)return localStorage.removeItem("token"),localStorage.removeItem("user"),{headers:{...r,authorization:""}}}catch(e){return console.error("Apollo Client - Erreur lors du d\xe9codage du token:",e),localStorage.removeItem("token"),localStorage.removeItem("user"),{headers:{...r,authorization:""}}}return{headers:{...r,authorization:s?"JWT ".concat(s):""}}}),m=(0,n.S)(e=>{let{graphQLErrors:t,networkError:r,operation:s,forward:l}=e;t&&t.forEach(e=>{let{message:t,locations:r,path:s,extensions:l}=e;console.error("[GraphQL error]: Message: ".concat(t,", Location: ").concat(r,", Path: ").concat(s)),((null==l?void 0:l.code)==="UNAUTHENTICATED"||t.includes("authentication")||t.includes("decoding signature")||t.includes("token")||t.includes("expired"))&&(localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="/errors/401"),((null==l?void 0:l.code)==="BAD_REQUEST"||t.includes("bad request")||t.includes("invalid"))&&(window.location.href="/errors/400"),((null==l?void 0:l.code)==="NOT_FOUND"||t.includes("not found"))&&(window.location.href="/errors/404"),((null==l?void 0:l.code)==="INTERNAL_SERVER_ERROR"||t.includes("server error"))&&(window.location.href="/errors/500")}),r&&(console.error("[Network error]: ".concat(r)),400===r.statusCode?window.location.href="/errors/400":401===r.statusCode?(localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="/errors/401"):404===r.statusCode?window.location.href="/errors/404":500===r.statusCode&&(window.location.href="/errors/500"))}),x=new s.R({link:(0,l.H)([m,u,d]),cache:new i.D,defaultOptions:{watchQuery:{errorPolicy:"all"},query:{errorPolicy:"all"}}})},9763:(e,t,r)=>{Promise.resolve().then(r.bind(r,9816))},9816:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>J});var s=r(5155),l=r(2115),i=r(1929),a=r(8095),n=r(5695),o=r(3593),c=r(6671),d=r(4203),u=r(5369),m=r(7650),x=r(3704),h=r(8790),p=r(488),g=r(9929);r(8413),r(1419);let f=e=>{let{open:t,onClose:r,onSave:i,initialGeojson:a}=e,[n,o]=(0,l.useState)(a||null),c=(0,l.useRef)(),[d,u]=(0,l.useState)("standard");if(!t)return null;let f=(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:(0,s.jsxs)("div",{className:"relative w-screen h-screen max-w-none max-h-none rounded-none bg-white flex flex-col",children:[(0,s.jsxs)("div",{className:"sticky top-0 z-10 bg-white px-6 py-4 border-b flex items-center justify-between",children:[(0,s.jsx)("h2",{className:"text-lg font-bold",children:"Dessiner la parcelle"}),(0,s.jsx)("div",{className:"flex items-center space-x-2",children:(0,s.jsxs)("select",{value:d,onChange:e=>u(e.target.value),className:"px-2 py-1 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-100 text-sm",children:[(0,s.jsx)("option",{value:"standard",children:"Standard"}),(0,s.jsx)("option",{value:"satellite",children:"Satellite + labels"})]})})]}),(0,s.jsx)("div",{className:"flex-1 flex flex-col overflow-hidden",children:(0,s.jsx)("div",{className:"flex-1",style:{height:"100vh",width:"100vw"},children:(0,s.jsxs)(x.W,{center:[-19,47],zoom:6,style:{height:"100vh",width:"100vw"},children:["standard"===d&&(0,s.jsx)(h.e,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"\xa9 OpenStreetMap contributors"}),"satellite"===d&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(h.e,{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles \xa9 Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"}),(0,s.jsx)(h.e,{url:"https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",attribution:"Labels \xa9 Esri"})]}),(0,s.jsx)(p.m,{ref:c,children:(0,s.jsx)(g.M,{position:"topright",onCreated:e=>{o(e.layer.toGeoJSON().geometry)},onEdited:e=>{e.layers.eachLayer(e=>{o(e.toGeoJSON().geometry)})},onDeleted:()=>{o(null)},draw:{rectangle:!1,circle:!1,circlemarker:!1,marker:!1,polyline:!1,polygon:{allowIntersection:!1,showArea:!0}},edit:{edit:!0,remove:!0}})})]})})}),(0,s.jsxs)("div",{className:"sticky bottom-0 z-10 bg-white px-6 py-4 border-t flex justify-end space-x-2",children:[(0,s.jsx)("button",{onClick:r,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Annuler"}),(0,s.jsx)("button",{onClick:()=>{n&&(i(n),r())},disabled:!n,className:"px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50",children:"Valider"})]})]})});return m.createPortal(f,document.body)};var b=r(7863),v=r(6474),j=r(4416),y=r(9869),N=r(7213),w=r(3225),C=r(3601),S=r(7994),k=r(1692),P=r(7062);async function z(e){let t=e.name.split(".").pop().toLowerCase();try{let s;if("geojson"===t||"json"===t)s=await A(e);else if("shp"===t||"zip"===t)s=await E(e);else if("kml"===t)s=await I(e);else throw Error("Format de fichier non support\xe9: ".concat(t));var r=s;if(!r)throw Error("GeoJSON vide ou invalide");if(r.type&&["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].includes(r.type))return r;if("Feature"===r.type&&r.geometry)return r.geometry;if("FeatureCollection"===r.type&&r.features&&r.features.length>0){let e=r.features[0];if(e.geometry)return e.geometry}throw Error("Impossible d'extraire la g\xe9om\xe9trie du fichier")}catch(e){throw console.error("Erreur lors du parsing du fichier:",e),Error("Impossible de lire le fichier: ".concat(e.message))}}async function A(e){let t=JSON.parse(await e.text());if(!t.type)throw Error("Format GeoJSON invalide");return t}async function E(e){let t,r=null;if(e.name.endsWith(".zip")){let s=new k,l=await s.loadAsync(e),i=Object.values(l.files).find(e=>e.name.endsWith(".shp")),a=Object.values(l.files).find(e=>e.name.endsWith(".dbf"));if(!i)throw Error("Aucun fichier .shp trouv\xe9 dans le ZIP");t=await i.async("arraybuffer"),a&&(r=await a.async("arraybuffer"))}else t=await e.arrayBuffer();let s=[],l=await S.ho(t,r),i=await l.read();for(;!i.done;)i.value&&s.push(i.value),i=await l.read();return{type:"FeatureCollection",features:s}}async function I(e){let t=await e.text(),r=new DOMParser().parseFromString(t,"text/xml");if(r.getElementsByTagName("parsererror").length>0)throw Error("Fichier KML invalide");return P.kml(r)}let L=e=>{var t,r,n;let{parcelle:c=null,onSuccess:d,onCancel:m,mode:x="add"}=e,{data:h}=(0,i.IT)(o.QG),{data:p}=(0,i.IT)(o.sI),g=(null==h||null==(t=h.me)?void 0:t.abreviation)||"",S=!!c,k=(null==p||null==(r=p.myParcelles)?void 0:r.length)||0,P=S?(null==c?void 0:c.nom)||"":"".concat(g,"_site de r\xe9f\xe9rence ").concat(k+1),[A,E]=(0,l.useState)({nom:P,nomPersonneReferente:(null==c?void 0:c.nomPersonneReferente)||"",poste:(null==c?void 0:c.poste)||"",telephone:(null==c?void 0:c.telephone)||"",email:(null==c?void 0:c.email)||"",superficie:(null==c?void 0:c.superficie)||"",pratique:(null==c?void 0:c.pratique)?c.pratique.split(",").map(e=>e.trim()):[],autresPratiques:"",nomProjet:(null==c?void 0:c.nomProjet)||"",description:(null==c?void 0:c.description)||"",images:[]}),[I,L]=(0,l.useState)([]),[q,R]=(0,l.useState)(!1),V=[{value:"Structure Brise-vent",label:"Structure Brise-vent"},{value:"Structure Pare feu",label:"Structure Pare feu"},{value:"Structures anti\xe9rosives",label:"Structures anti\xe9rosives"},{value:"Structure Cultures en Couloir/all\xe9e",label:"Structure Cultures en Couloir/all\xe9e"},{value:"Pratiques de taillage, coupe et application engrais verts",label:"Pratiques de taillage, coupe et application engrais verts"},{value:"Pratiques couverture du sol",label:"Pratiques couverture du sol"},{value:"Pratiques/structures conservation d'eau",label:"Pratiques/structures conservation d'eau"},{value:"Syst\xe8me multi-\xe9tage diversifi\xe9",label:"Syst\xe8me multi-\xe9tage diversifi\xe9"},{value:"Arbres Autochtones",label:"Arbres Autochtones"},{value:"Production \xe9pices",label:"Production \xe9pices"},{value:"Production Bois \xe9nergie",label:"Production Bois \xe9nergie"},{value:"Production fruit",label:"Production fruit"},{value:"Int\xe9gration cultures vivri\xe8res",label:"Int\xe9gration cultures vivri\xe8res"},{value:"Int\xe9gration d'\xe9levage",label:"Int\xe9gration d'\xe9levage"},{value:"autres",label:"Autres (saisir manuellement)"}];(0,l.useEffect)(()=>{if(S&&c&&c.images&&Array.isArray(c.images)){let e="".concat("http://91.204.209.201:8000","/media/")||0;L(c.images.slice(0,3).map(t=>({id:t.id,url:t.image?t.image.startsWith("http")?t.image:"".concat(e.replace(/\/$/,""),"/").concat(t.image.replace(/^\//,"")):"",titre:t.titre||"",description:t.description||"",isExisting:!0})))}else L([])},[S,c]);let[M,_]=(0,l.useState)([]),[T,F]=(0,l.useState)((null==c?void 0:c.geojson)||null),[O,D]=(0,l.useState)(!1),{showSuccess:B,showError:G}=(0,u.d)(),[U,W]=(0,l.useState)(!1),[H,J]=(0,l.useState)(!1),[Q,{loading:$}]=(0,a.n)(o.Si),[K,{loading:Z}]=(0,a.n)(o.$C),X=((null==h||null==(n=h.me)?void 0:n.nomProjet)||"").split(",").map(e=>e.trim()).filter(Boolean);(0,l.useEffect)(()=>{!S&&g&&E(e=>({...e,nom:"".concat(g,"_site de r\xe9f\xe9rence ").concat(k+1)}))},[g,k,S]);let Y=e=>{let{name:t,value:r,type:s,checked:l,files:i}=e.target;if("file"===s&&i){let e=Array.from(i);setImageFiles(t=>[...t,...e]);let t=e.map(e=>URL.createObjectURL(e));_(e=>[...e,...t])}else if("checkbox"===s)E(e=>({...e,[t]:l}));else if("superficie"===t){let e=""===r?"":r;E(r=>({...r,[t]:e}))}else E(e=>({...e,[t]:r}))},ee=e=>{E(t=>{let r,s=t.pratique||[],l=s.includes(e);return(r=l?s.filter(t=>t!==e):[...s,e],"autres"===e&&l)?{...t,pratique:r,autresPratiques:""}:{...t,pratique:r}})},et=()=>{let e=[...A.pratique];if(e.includes("autres")&&A.autresPratiques){let t=e.indexOf("autres");e.splice(t,1);let r=A.autresPratiques.split(",").map(e=>e.trim()).filter(Boolean);e.push(...r)}return e.join(", ")},er=async e=>{let t=e.target.files[0];if(t)try{let e=await z(t);if(F(e),e&&("Polygon"===e.type||"MultiPolygon"===e.type)){let t=function(e){try{if(!e)return"";return(C.W({type:"Feature",geometry:e})/1e4).toFixed(2)}catch(e){return console.error("Erreur lors du calcul de la superficie:",e),""}}(e);E(e=>({...e,superficie:t}))}B("Fichier charg\xe9 avec succ\xe8s")}catch(e){console.error("Erreur lors du chargement du fichier:",e),G(e.message||"Erreur lors du chargement du fichier")}},es=e=>{L(t=>t.filter((t,r)=>r!==e))},el=(e,t,r)=>{L(s=>s.map((s,l)=>l===e?{...s,[t]:r}:s))},ei=async e=>{e.preventDefault(),W(!0)},ea=async()=>{J(!0);let e=T;if(O&&(e=null),!e){G("Veuillez fournir un fichier GeoJSON ou dessiner sur la carte."),J(!1);return}try{let t=I.filter(e=>!e.isExisting).map(e=>e.file),r=[];if("edit"===x&&c&&Array.isArray(c.images)){let e=I.filter(e=>e.isExisting).map(e=>e.id);r=c.images.filter(t=>!e.includes(t.id)).map(e=>e.id)}let s={...A,superficie:A.superficie&&""!==A.superficie?parseFloat(A.superficie):null,pratique:et(),geojson:JSON.stringify(e),images:t.length>0?t:null,imagesToDelete:r.length>0?r:null};if("edit"===x&&c){let{data:e}=await K({variables:{id:c.id,...s}});e.updateParcelle.success?(B("Site de r\xe9f\xe9rence mis \xe0 jour avec succ\xe8s !"),d&&d(e.updateParcelle.parcelle)):G(e.updateParcelle.message)}else{let{data:e}=await Q({variables:s});e.createParcelle.success?(B("Site de r\xe9f\xe9rence cr\xe9\xe9 avec succ\xe8s !"),d&&d(e.createParcelle.parcelle)):G(e.createParcelle.message)}}catch(e){console.error("Erreur lors de la soumission:",e),G("Une erreur est survenue. Veuillez r\xe9essayer.")}finally{J(!1),W(!1)}};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"bg-white border-b border-gray-200 p-6 rounded-t-lg",children:(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"edit"===x?"Modifier le site de r\xe9f\xe9rence":"Ajouter un site de r\xe9f\xe9rence"})}),(0,s.jsx)("div",{className:"bg-white overflow-y-auto max-h-[60vh]",children:(0,s.jsx)("div",{className:"p-6",children:(0,s.jsxs)("form",{onSubmit:ei,className:"space-y-6",children:[(0,s.jsxs)("div",{className:"border-b pb-4",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Informations de base"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nom du site de r\xe9f\xe9rence *"}),(0,s.jsx)("input",{type:"text",name:"nom",required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-100",value:A.nom,onChange:Y,readOnly:!S})]})})]}),(0,s.jsxs)("div",{className:"border-b pb-4",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Personne r\xe9f\xe9rente"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nom de la personne r\xe9f\xe9rente"}),(0,s.jsx)("input",{type:"text",name:"nomPersonneReferente",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",value:A.nomPersonneReferente,onChange:Y})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Poste"}),(0,s.jsx)("input",{type:"text",name:"poste",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",value:A.poste,onChange:Y})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"T\xe9l\xe9phone"}),(0,s.jsx)("input",{type:"tel",name:"telephone",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",value:A.telephone,onChange:Y})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),(0,s.jsx)("input",{type:"email",name:"email",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",value:A.email,onChange:Y})]})]})]}),(0,s.jsxs)("div",{className:"border-b pb-4",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Informations agricoles"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"md:col-span-2",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Pratiques (plusieurs choix possibles)"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)("button",{type:"button",onClick:()=>R(!q),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-left flex items-center justify-between",children:[(0,s.jsx)("span",{className:"text-gray-700",children:0===A.pratique.length?"S\xe9lectionnez les pratiques...":"".concat(A.pratique.length," pratique(s) s\xe9lectionn\xe9e(s)")}),q?(0,s.jsx)(b.A,{size:20}):(0,s.jsx)(v.A,{size:20})]}),A.pratique.length>0&&(0,s.jsx)("div",{className:"mt-2 flex flex-wrap gap-2",children:A.pratique.map(e=>{let t=V.find(t=>t.value===e);return(0,s.jsxs)("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800",children:[t?t.label:e,(0,s.jsx)("button",{type:"button",onClick:()=>ee(e),className:"ml-1 inline-flex items-center justify-center w-4 h-4 rounded-full text-indigo-400 hover:bg-indigo-200 hover:text-indigo-600",children:(0,s.jsx)(j.A,{size:12})})]},e)})}),q&&(0,s.jsx)("div",{className:"absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:V.map(e=>(0,s.jsx)("div",{className:"p-2 hover:bg-gray-50",children:(0,s.jsxs)("label",{className:"flex items-center cursor-pointer",children:[(0,s.jsx)("input",{type:"checkbox",checked:A.pratique.includes(e.value),onChange:()=>ee(e.value),className:"h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"}),(0,s.jsx)("span",{className:"ml-2 text-sm text-gray-700",children:e.label})]})},e.value))})]}),A.pratique.includes("autres")&&(0,s.jsx)("input",{type:"text",name:"autresPratiques",className:"mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",placeholder:"Saisir les pratiques s\xe9par\xe9es par virgule",value:A.autresPratiques,onChange:Y})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nom du projet"}),(0,s.jsxs)("select",{name:"nomProjet",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",value:A.nomProjet,onChange:Y,children:[(0,s.jsx)("option",{value:"",children:"S\xe9lectionner un projet"}),X.map((e,t)=>(0,s.jsx)("option",{value:e,children:e},t))]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description"}),(0,s.jsx)("textarea",{name:"description",rows:"4",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",value:A.description,onChange:Y,placeholder:"Description du site de r\xe9f\xe9rence..."})]})]})]}),(0,s.jsxs)("div",{className:"border-b pb-4",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"G\xe9olocalisation et superficie"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Superficie (ha)"}),(0,s.jsx)("input",{type:"number",step:"0.01",name:"superficie",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",value:A.superficie,onChange:Y,readOnly:!0})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fichier GeoJSON *"}),(0,s.jsx)("input",{type:"file",accept:".geojson,.json",onChange:er,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500",disabled:!!T}),(0,s.jsx)("button",{type:"button",onClick:()=>D(!0),className:"mt-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700",children:"Dessiner sur la carte"}),T&&(0,s.jsx)("p",{className:"mt-1 text-sm text-green-600",children:"✓ Site de r\xe9f\xe9rence d\xe9fini"}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Importer un fichier OU dessiner sur la carte."}),(0,s.jsx)(f,{open:O,onClose:()=>D(!1),onSave:e=>{F(e);try{if(e&&("Polygon"===e.type||"MultiPolygon"===e.type)){let t=(C.W({type:"Feature",geometry:e})/1e4).toFixed(2);E(e=>({...e,superficie:t}))}}catch(e){}D(!1)}})]})]})]}),(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Images du site de r\xe9f\xe9rence (max 3)"}),(0,s.jsxs)("div",{className:"space-y-4",children:[I.length<2&&(0,s.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[(0,s.jsx)(y.A,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsxs)("label",{htmlFor:"photo-upload",className:"cursor-pointer",children:[(0,s.jsx)("span",{className:"text-sm font-medium text-indigo-600 hover:text-indigo-500",children:"Cliquez pour ajouter une image"}),(0,s.jsx)("input",{id:"photo-upload",type:"file",accept:"image/*",multiple:!0,onChange:e=>{let t=Array.from(e.target.files);if(I.length+t.length>3)return void G("Vous pouvez ajouter au maximum 3 images.");let r=t.map(e=>({file:e,url:URL.createObjectURL(e),titre:"",description:"",isExisting:!1}));L(e=>[...e,...r].slice(0,3))},className:"hidden"})]})}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"PNG, JPG jusqu'\xe0 10MB"})]}),I.length>0&&(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:I.map((e,t)=>(0,s.jsxs)("div",{className:"relative border rounded-lg p-4",children:[(0,s.jsx)("button",{type:"button",onClick:()=>es(t),className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:(0,s.jsx)(j.A,{size:16})}),(0,s.jsxs)("div",{className:"flex items-center space-x-3 mb-3",children:[(0,s.jsx)(N.A,{className:"h-8 w-8 text-gray-400"}),(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)("input",{type:"text",placeholder:"Titre de l'image",value:e.titre,onChange:e=>el(t,"titre",e.target.value),className:"w-full text-sm border border-gray-300 rounded px-2 py-1"})})]}),(0,s.jsx)("img",{src:e.url,alt:e.titre||"Image du site",className:"w-full h-32 object-cover rounded"}),(0,s.jsx)("textarea",{placeholder:"Description de l'image",value:e.description,onChange:e=>el(t,"description",e.target.value),className:"w-full mt-2 text-sm border border-gray-300 rounded px-2 py-1 resize-none",rows:"2"})]},t))})]})]})})}),(0,s.jsx)("div",{className:"bg-white border-t border-gray-200 p-6 rounded-b-lg",children:(0,s.jsxs)("div",{className:"flex justify-end space-x-4",children:[(0,s.jsx)("button",{type:"button",onClick:m,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Annuler"}),(0,s.jsx)("button",{onClick:ei,disabled:$||Z,className:"px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50",children:$||Z?(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"edit"===x?"Mise \xe0 jour...":"Cr\xe9ation..."]}):"edit"===x?"Mettre \xe0 jour":"Cr\xe9er le site de r\xe9f\xe9rence"})]})}),q&&(0,s.jsx)("div",{className:"fixed inset-0 z-5",onClick:()=>R(!1)}),U&&(0,s.jsx)(w.A,{isOpen:U,onClose:()=>W(!1),onConfirm:ea,title:"edit"===x?"Confirmer la modification":"Confirmer la cr\xe9ation",message:"edit"===x?"Voulez-vous vraiment modifier ce site de r\xe9f\xe9rence ?":"Voulez-vous vraiment cr\xe9er ce site de r\xe9f\xe9rence ?",confirmText:"edit"===x?"Mettre \xe0 jour":"Cr\xe9er",confirmButtonClass:H?"bg-indigo-400 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-700",cancelButtonClass:H?"cursor-not-allowed":"bg-gray-300 hover:bg-gray-400",confirmDisabled:H,confirmLoading:H})]})},q=e=>{let{open:t,onClose:r,parcelle:l=null,onSuccess:i}=e;return t?(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] p-0 relative animate-fade-in flex flex-col",children:[(0,s.jsx)("button",{onClick:r,className:"absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl font-bold focus:outline-none z-10","aria-label":"Fermer",children:"\xd7"}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,s.jsx)(L,{parcelle:l,onSuccess:e=>{i&&i(e),r&&r()},onCancel:r,mode:l?"edit":"add"})})]})}):null},R=e=>{let{onImportSuccess:t}=e,[r,i]=(0,l.useState)(null),[n,c]=(0,l.useState)(!1),[d,m]=(0,l.useState)(!1),[x,h]=(0,l.useState)([]),{showSuccess:p,showError:g}=(0,u.d)(),[f]=(0,a.n)(o.K4),[b]=(0,a.n)(o.rW),v=async()=>{c(!0);try{let{data:e}=await f();if(e.exportParcellesCsv.success){let t=new Blob([e.exportParcellesCsv.csvData],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),s=URL.createObjectURL(t);r.setAttribute("href",s),r.setAttribute("download","sites_de_reference_export_".concat(new Date().toISOString().split("T")[0],".csv")),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),p(e.exportParcellesCsv.message)}else g(e.exportParcellesCsv.message)}catch(e){g("Erreur lors de l'export CSV"),console.error("Export error:",e)}finally{c(!1)}},j=async()=>{if(!r)return void g("Veuillez s\xe9lectionner un fichier CSV \xe0 importer.");m(!0);try{let{data:e}=await b({variables:{csvFile:r}});if(e.importParcellesCsv.success){p(e.importParcellesCsv.message),i(null),h(e.importParcellesCsv.errors||[]);let r=document.getElementById("csv-file-input");r&&(r.value=""),t&&t()}else g(e.importParcellesCsv.message),h(e.importParcellesCsv.errors||[])}catch(e){g("Erreur lors de l'import CSV"),console.error("Import error:",e)}finally{m(!1)}};return(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-semibold mb-6 text-gray-800 text-center",children:"Import/Export CSV Parcelles"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h4",{className:"text-lg font-medium text-gray-700",children:"Exporter les parcelles"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"T\xe9l\xe9chargez toutes vos parcelles au format CSV pour sauvegarder ou partager vos donn\xe9es."}),(0,s.jsx)("button",{onClick:v,disabled:n,className:"w-full bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center",children:n?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Export en cours..."]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Exporter en CSV"]})})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h4",{className:"text-lg font-medium text-gray-700",children:"Importer des parcelles"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Importez des parcelles depuis un fichier CSV. T\xe9l\xe9chargez d'abord le mod\xe8le pour voir le format attendu."}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("button",{onClick:()=>{let e=new Blob(["Nom,Nom Personne R\xe9f\xe9rente,Poste,T\xe9l\xe9phone,Email,Superficie,Pratique,Nom projet,Description,geometrie\nParcelle Exemple,Jean Dupont,Responsable Terrain,+261 32 12 34 56,jean.dupont@email.com,5.75,Agroforesterie, Cultures vivri\xe8res,Projet Agro\xe9cologique 2024,Parcelle bien expos\xe9e avec syst\xe8me agroforestier,[[47.5208,-18.8792],[47.5228,-18.8792],[47.5228,-18.8812],[47.5208,-18.8812],[47.5208,-18.8792]]"],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),r=URL.createObjectURL(e);t.setAttribute("href",r),t.setAttribute("download","template_sites_de_reference_import.csv"),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)},className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center",children:[(0,s.jsx)("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"T\xe9l\xe9charger le mod\xe8le CSV"]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"csv-file-input",className:"block text-sm font-medium text-gray-700 mb-2",children:"S\xe9lectionner un fichier CSV"}),(0,s.jsx)("input",{id:"csv-file-input",type:"file",accept:".csv",onChange:e=>{let t=e.target.files[0];t&&"text/csv"===t.type?(i(t),h([])):(g("Veuillez s\xe9lectionner un fichier CSV valide."),i(null))},className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"})]}),(0,s.jsx)("button",{onClick:j,disabled:!r||d,className:"w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center",children:d?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Import en cours..."]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),"Importer le CSV"]})})]})]})]}),x.length>0&&(0,s.jsxs)("div",{className:"mt-6",children:[(0,s.jsx)("h5",{className:"text-sm font-medium text-red-700 mb-2",children:"Erreurs d'import :"}),(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-md p-3 max-h-40 overflow-y-auto",children:x.map((e,t)=>(0,s.jsxs)("div",{className:"text-sm text-red-600 mb-1",children:["• ",e]},t))})]}),(0,s.jsxs)("div",{className:"mt-6 p-4 bg-gray-50 rounded-md",children:[(0,s.jsx)("h5",{className:"text-sm font-medium text-gray-700 mb-2",children:"Instructions :"}),(0,s.jsxs)("ul",{className:"text-sm text-gray-600 space-y-1",children:[(0,s.jsxs)("li",{children:["• Le champ ",(0,s.jsx)("strong",{children:"Nom"})," est obligatoire"]}),(0,s.jsxs)("li",{children:["• La ",(0,s.jsx)("strong",{children:"Superficie"})," doit \xeatre un nombre d\xe9cimal (ex: 5.75)"]}),(0,s.jsxs)("li",{children:["• Les ",(0,s.jsx)("strong",{children:"Pratiques"})," peuvent \xeatre multiples, s\xe9par\xe9es par des virgules"]}),(0,s.jsxs)("li",{children:["• La ",(0,s.jsx)("strong",{children:"g\xe9om\xe9trie"})," doit \xeatre au format liste de points [[lon,lat],[lon,lat],...]"]}),(0,s.jsx)("li",{children:"• Tous les autres champs sont optionnels"}),(0,s.jsx)("li",{children:"• Les parcelles import\xe9es sans g\xe9om\xe9trie auront un polygone par d\xe9faut"})]})]})]})};var V=r(6927),M=r(183),_=r(7075),T=r(2657),F=r(3717),O=r(4126),D=r(4616),B=r(3578),G=r(2355),U=r(3052),W=r(6254),H=r(4664);function J(){let{isAuthenticated:e,isLoading:t}=(0,W.h)(),r=(0,n.useRouter)(),[u,m]=(0,l.useState)(!1),[x]=(0,l.useState)(null),[h,p]=(0,l.useState)(!1),[g,f]=(0,l.useState)(null),[b,v]=(0,l.useState)("street"),[j]=(0,l.useState)(""),[y]=(0,l.useState)("nom"),[N]=(0,l.useState)("asc"),[C,S]=(0,l.useState)(1),[k,P]=(0,l.useState)(10),[z,A]=(0,l.useState)(!1),[E,I]=(0,l.useState)(!1),[L,J]=(0,l.useState)(!1),[Q,$]=(0,l.useState)(null),[K,Z]=(0,l.useState)(!1),[X,Y]=(0,l.useState)(null);(0,l.useEffect)(()=>{e||t||r.replace("/login")},[e,t,r]);let{data:ee,loading:et,refetch:er}=(0,i.IT)(o.sI,{skip:!e}),[es]=(0,a.n)(o.LN),el=[{key:"nom",label:"Site de r\xe9f\xe9rence"},{key:"superficie",label:"Superficie"},{key:"personneReferente",label:"Personne r\xe9f\xe9rente"},{key:"nomProjet",label:"Projet rattach\xe9"}],[ei]=(0,l.useState)(el.map(e=>e.key)),ea=[...ei.map(e=>{let t=el.find(t=>t.key===e);return t?"personneReferente"===t.key?{accessorKey:"Personne r\xe9f\xe9rente",header:"Personne r\xe9f\xe9rente",cell:e=>{let t=e.row.original;return(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:t.nomPersonneReferente||"-"}),(0,s.jsx)("div",{className:"text-xs text-gray-500",children:t.poste||"-"}),(0,s.jsx)("div",{className:"text-xs text-gray-500",children:t.telephone||"-"}),(0,s.jsx)("div",{className:"text-xs text-gray-500",children:t.email||"-"})]})}}:{accessorKey:t.key,header:t.label,cell:e=>{let r=e.row.original;return"superficie"===t.key?r.superficie?"".concat(r.superficie," ha"):"-":"createdAt"===t.key?r.createdAt?new Date(r.createdAt).toLocaleDateString("fr-FR"):"":r[t.key]||"-"}}:null}).filter(Boolean),{id:"actions",header:()=>(0,s.jsx)("div",{className:"text-center",children:"Actions"}),cell:e=>{let{row:t}=e;return(0,s.jsxs)("div",{className:"flex gap-2 justify-center",children:[(0,s.jsx)(M.$,{variant:"outline",size:"sm",onClick:()=>em(t.original),title:"Voir les d\xe9tails",className:"text-blue-600 hover:text-blue-800",children:(0,s.jsx)(T.A,{size:15})}),(0,s.jsx)(M.$,{variant:"outline",size:"sm",onClick:()=>eu(t.original),title:"Modifier le site de r\xe9f\xe9rence",children:(0,s.jsx)(F.A,{size:15})}),(0,s.jsx)(M.$,{variant:"destructive",size:"sm",onClick:()=>ec(t.original.id),title:"Supprimer le site de r\xe9f\xe9rence",children:(0,s.jsx)(O.A,{size:15})})]})},enableSorting:!1,enableHiding:!1}],en=(0,l.useMemo)(()=>{let e=(null==ee?void 0:ee.myParcelles)||[];if(j){let t=j.toLowerCase();e=e.filter(e=>ei.some(r=>{if("personneReferente"===r)return e.nomPersonneReferente&&e.nomPersonneReferente.toLowerCase().includes(t)||e.poste&&e.poste.toLowerCase().includes(t)||e.telephone&&e.telephone.toLowerCase().includes(t)||e.email&&e.email.toLowerCase().includes(t);let s=e[r];return null!=s&&String(s).toLowerCase().includes(t)}))}return[...e].sort((e,t)=>{let r=e[y]||"",s=t[y]||"";if("string"==typeof r&&"string"==typeof s){if(r<s)return"asc"===N?-1:1;if(r>s)return"asc"===N?1:-1}return 0})},[null==ee?void 0:ee.myParcelles,j,y,N,ei]),eo=(0,l.useMemo)(()=>{let e=(C-1)*k;return en.slice(e,e+k)},[en,C,k]),ec=e=>{Y(e),Z(!0)},ed=async()=>{if(X)try{let{data:e}=await es({variables:{id:X}});e.deleteParcelle.success?(c.oR.success("Site de r\xe9f\xe9rence supprim\xe9 avec succ\xe8s"),er()):c.oR.error(e.deleteParcelle.message||"Erreur lors de la suppression")}catch(e){c.oR.error("Erreur lors de la suppression"),console.error("Delete error:",e)}finally{Z(!1),Y(null)}},eu=e=>{f(e),m(!0)},em=e=>{$(e),J(!0)},ex=Math.ceil(en.length/k),eh=(0,s.jsx)("div",{className:"flex items-center gap-2",children:(0,s.jsxs)(_.l6,{value:String(k),onValueChange:e=>{P(Number(e)),S(1)},children:[(0,s.jsx)(_.bq,{className:"w-32",children:(0,s.jsx)(_.yv,{placeholder:"Lignes par page"})}),(0,s.jsx)(_.gC,{children:[10,25,50].map(e=>(0,s.jsxs)(_.eb,{value:String(e),children:[e," par page"]},e))})]})});if(t||et)return(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600",children:"Chargement..."})]})});let ep=(null==ee?void 0:ee.myParcelles)||[];return(0,s.jsxs)("div",{className:"min-h-screen bg-white",children:[(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:(0,s.jsxs)("div",{className:"flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4 mb-6",children:[(0,s.jsxs)("div",{className:"flex-shrink-0",children:[(0,s.jsx)("h1",{className:"text-2xl lg:text-3xl font-extrabold midnight-blue-text drop-shadow-sm",children:"Mes sites de r\xe9f\xe9rence"}),(0,s.jsxs)("p",{className:"text-gray-700 mt-1 font-medium text-sm lg:text-base",children:[ep.length," site",1!==ep.length?"s":""," de r\xe9f\xe9rence au total"]})]}),!(z||h)&&(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[(0,s.jsxs)("button",{onClick:()=>{f(null),m(!0)},className:"px-4 py-2 midnight-blue-btn rounded-md shadow font-bold transition flex items-center justify-center gap-2 text-sm",title:"Ajouter un nouveau site de r\xe9f\xe9rence",children:[(0,s.jsx)(D.A,{size:16})," Ajouter un site"]}),(0,s.jsxs)("button",{onClick:()=>I(!0),className:"px-4 py-2 midnight-blue-btn rounded-md shadow font-bold transition flex items-center justify-center gap-2 text-sm",title:"Import/Export CSV",children:[(0,s.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Import/Export CSV"]})]}),(z||h)&&(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)("select",{value:b,onChange:e=>v(e.target.value),className:"px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-blue-900 font-semibold shadow-sm text-sm",children:[(0,s.jsx)("option",{value:"street",children:"Carte routi\xe8re"}),(0,s.jsx)("option",{value:"satellite",children:"Satellite"}),(0,s.jsx)("option",{value:"hybrid",children:"Hybride"})]}),!h&&(0,s.jsx)("button",{onClick:()=>p(!0),className:"px-3 py-2 midnight-blue-btn rounded-md font-semibold shadow-sm transition text-sm",title:"Afficher la carte en plein \xe9cran",children:"Plein \xe9cran"}),h&&(0,s.jsx)("button",{onClick:()=>p(!1),className:"px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 font-semibold shadow-sm transition text-sm",title:"Quitter le plein \xe9cran",children:"Quitter"})]})]})}),z||h?(0,s.jsxs)("div",{className:h?"fixed inset-0 z-50 bg-white bg-opacity-95 flex flex-col":"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",style:h?{height:"100vh",width:"100vw",margin:0,padding:0}:{},children:[!h&&(0,s.jsx)("div",{className:"flex justify-end mb-2",children:(0,s.jsxs)("button",{onClick:()=>A(!1),className:"px-3 py-2 rounded-md border midnight-blue-border bg-white midnight-blue-text hover:bg-blue-50 flex items-center gap-2 shadow-sm transition font-semibold text-sm",children:[(0,s.jsx)(B.A,{size:16}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Voir le tableau"}),(0,s.jsx)("span",{className:"sm:hidden",children:"Tableau"})]})}),(0,s.jsxs)("div",{className:h?"flex-1 flex flex-col relative":"bg-white rounded-lg shadow-lg overflow-hidden",style:h?{height:"100%",width:"100%",maxWidth:"100vw",maxHeight:"100vh",margin:0,padding:0}:{},children:[h&&(0,s.jsx)("button",{onClick:()=>p(!1),className:"absolute top-4 right-4 z-50 px-4 py-2 bg-gray-700 text-white rounded-xl shadow-lg hover:bg-gray-900 font-bold transition",title:"Quitter le plein \xe9cran",children:"Quitter plein \xe9cran"}),(0,s.jsxs)("div",{className:"p-4 border-b",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"Carte des sites de r\xe9f\xe9rence"}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:[ep.length," site",1!==ep.length?"s":""," de r\xe9f\xe9rence affich\xe9",1!==ep.length?"s":""," sur la carte"]})]}),(0,s.jsx)("div",{className:h?"flex-1 flex":"",style:h?{height:"100%",width:"100%",minHeight:0,minWidth:0,margin:0,padding:0}:{height:"600px",width:"100%"},children:et?(0,s.jsx)("div",{className:"flex items-center justify-center w-full h-full",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-2 text-gray-600",children:"Chargement de la carte..."})]})}):(0,s.jsx)(d.A,{parcelles:ep,sieges:[],pepinieres:[],onParcelleClick:x,mapStyle:b,style:h?{height:"100%",width:"100%"}:{height:"100%",minHeight:400},mode:"parcelle"})})]})]}):(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,s.jsx)("div",{className:"flex justify-end mb-2",children:(0,s.jsxs)("button",{onClick:()=>A(!0),className:"px-3 py-2 rounded-md border midnight-blue-border bg-white midnight-blue-text hover:bg-blue-50 flex items-center gap-2 shadow-sm transition font-semibold text-sm",children:[(0,s.jsx)(B.A,{size:16}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Voir la carte"}),(0,s.jsx)("span",{className:"sm:hidden",children:"Carte"})]})}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:[(0,s.jsx)(V.b,{columns:ea,data:eo,filterKey:"nom",filterPlaceholder:"Rechercher par nom...",actions:eh}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-b-2xl border-t border-blue-100",children:[(0,s.jsxs)("div",{className:"text-sm text-blue-900 font-semibold",children:["Page ",C," sur ",ex]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(M.$,{variant:"outline",size:"sm",disabled:1===C,onClick:()=>S(C-1),className:"flex items-center gap-1",children:[(0,s.jsx)(G.A,{size:14})," ",(0,s.jsx)("span",{className:"hidden sm:inline",children:"Pr\xe9c\xe9dent"})]}),(0,s.jsxs)(M.$,{variant:"outline",size:"sm",disabled:C===ex,onClick:()=>S(C+1),className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"hidden sm:inline",children:"Suivant"})," ",(0,s.jsx)(U.A,{size:14})]})]})]})]})]}),(0,s.jsx)(q,{open:u,onClose:()=>{m(!1),f(null)},parcelle:g,onSuccess:()=>{m(!1),f(null),er()},title:g?"Modifier le site de r\xe9f\xe9rence":"Ajouter un nouveau site de r\xe9f\xe9rence",description:g?"Modifiez les informations du site.":"Remplissez le formulaire pour ajouter un nouveau site."}),E&&(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-2xl max-w-2xl w-full p-6 relative",children:[(0,s.jsx)("button",{onClick:()=>I(!1),className:"absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-xl font-bold",title:"Fermer",children:"\xd7"}),(0,s.jsx)(R,{onImportSuccess:()=>{I(!1),er()}})]})}),L&&Q&&(0,s.jsx)(H.A,{parcelle:Q,onClose:()=>{J(!1),$(null)},onEdit:()=>{J(!1),$(null),eu(Q)}}),K&&(0,s.jsx)(w.A,{isOpen:K,onClose:()=>{Z(!1),Y(null)},onConfirm:ed,title:"Confirmer la suppression",message:"\xcates-vous s\xfbr de vouloir supprimer ce site de r\xe9f\xe9rence ?",confirmText:"Supprimer",confirmButtonClass:"bg-red-600 hover:bg-red-700"})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[2046,9484,3417,1761,2871,8916,1929,9516,59,9547,6944,6671,3123,6800,554,4664,4203,8441,1684,7358],()=>t(9763)),_N_E=e.O()}]);